---

- name: Configure GitHub runner
  connection: local
  become: true
  become_user: root
  hosts: localhost
  vars:
    github_repo_url: ""
    github_runner_name: ""
    github_token: ""
  tasks:
    - name: Set the hostname
      ansible.builtin.hostname:
        name: GitRunner
    
    - name: Add the runner user if not already created
      ansible.builtin.user:
        name: runner
        shell: /bin/bash
        groups: runner
        append: yes
        create_home: true

    - name: Install Docker dependencies
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
        state: present
        update_cache: yes
    
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/ubuntu/gpg
        state: present
    
    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
    
    - name: Install Docker
      apt:
        name: docker-ce
        state: present
        update_cache: yes
    
    - name: Add user to docker group
      user:
        name: "runner"
        groups: docker
        append: yes
    
    - name: Create GitHub runner directory
      file:
        path: /home/runner/actions-runner
        state: directory
        owner: "runner"
        group: "runner"
        mode: '0755'
    
    - name: Create entrypoint script
      become: true
      become_user: runner
      copy:
        dest: /home/runner/entrypoint.sh
        content: |
          #!/bin/bash
          set -e
          rm -rf /home/runner/_work
          ./config.sh --url "${REPO_URL}" --token "${RUNNER_TOKEN}" --name "${RUNNER_NAME}" --unattended --replace
          ./run.sh
        mode: '0755'

    - name: Run GitHub runner docker container
      become: true
      become_user: runner
      shell: |
        docker run -d \
          --name github-runner \
          --restart always \
          -v /home/runner/actions-runner:/home/runner/work \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v /home/runner/entrypoint.sh:/entrypoint.sh \
          -e RUNNER_NAME="{{ github_runner_name }}" \
          -e REPO_URL="{{ github_repo_url }}" \
          -e RUNNER_TOKEN="{{ github_token }}" \
          ghcr.io/actions/actions-runner:latest \
          /entrypoint.sh
